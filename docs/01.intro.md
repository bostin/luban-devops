# 架构说明

## 系统介绍

鲁班微服务架构, 是商派的第三代技术架构.

第一代是ecshop / shopex. 基本的MVC结构, 带有插件化的能力.

第二代是ecstore背后的ecos, 具有类似OSGI的组件化能力.

第三代是鲁班微服务架构,  其特点是通过模块的服务化拆解, 来提供系统的灵活性. 即使某个模块出现瓶颈, 也可以单独被替换.

具有类似设计的架构也有很多实现,  而鲁班这套技术架构有如下特性:

1. 架构与语言无关, **意味着最大化的利用现有资源, 多个技术团队可以协同工作**.
1. 完全基于开源社区的基础设施,  商派只是做了技术选型和约定, 并制作了一些加速开发的小工具.  **在保证架构生命周期的同时, 也不会被厂商所绑定.**
1. 平衡易用性与灵活性,  商派专注于电子商务技术服务, 要保证能将技术能力转移给最终使用者, 因此在技术选型的时候会考虑交付的复杂度, 与上手程度, 甚至最终用户的团队建设.

在正式介绍本架构之前,  我们先打到一只纸老虎: 微服务

### 微服务 - 名词都是纸老虎


### 架构选型

架构分为业务层实现(Application), 与后端服务层(Service).

* 服务层Service, 封装许多接口. 这些接口的设计目标是稳定的, 灵活的, 具有较强抽象的. 作为后端的工具箱.
* 业务实现层(Application), 就是具体的前端站点, 对应的是php的laravel, 或者java的spring mvc.

按照MVC的概念, 业务层可以将服务层当做一种特殊的model, 只不过这种model是通过接口调用的而已.  因此一个简单的应用可以完全编写controller + view + service model实现.

#### 服务管理

一个典型的项目, 如果发展的中后期, 会有几十个服务, 上千个接口. 而随着业务的发展, 系统可能有几十, 几百, 几千的服务器节点.  

那么系统一共有多少服务; 每个服务部署在什么地址, 一个新的服务如何被团队获知; 同一种服务, 其配置参数都是怎样的.  就需要一套服务注册表的东西, 我们选用的是etcd, 一种分布式存储实现, 类似zookeeper, 但要更简洁.

此外, 调用服务的时候, 如何通信,  数据如何封包. 我们选用的是hprose, 其支持非常多的语言, 并且拥有非常不错的性能.

* 服务注册表 - etcd <https://coreos.com/etcd>
* 服务通信 - hprose <http://hprose.com/>

#### 服务的节点注册与配置管理

etcd 提供了一个带目录结构的key-value存储, 其自身有着完善的高可用设计.  著名的容器编排工具kubernetes也是基于etcd.

在etcd的目录结构里, 我们做了如下约定:

 * /luban/nodes/{service_name} - 存放服务的节点
 * /luban/config/{service_name} - 存放服务的配置信息
 * /luban/mq - 存放集群中的消息队列配置信息

例如, 一个服务叫做hello. 它启动在 192.168.0.1:8866 地址, 通过tcp模式, 并且暴露成hprose通信格式.

那么, 他会在启动时, 在etcd中创建一个 /luban/nodes/hello/192.168.0.1:8866 的数据项, 内容不限.
etcd的set允许带有一个ttl参数, 我们的约定, ttl=5, 即set的数据项在5秒后会自动被删除.  而在hello服务中, 会每隔3秒钟set一次. 那么如果hello服务挂掉, 在5秒后会被自动移除nodes里的信息.

hello在启动时, 会读取 /luban/config/hello 下的所有数据项,  作为自己的配置参数.

etcd 包含了一个操作工具叫做etcdctl. 我们可以使用 *etcdctl ls /luban/nodes/* 查看有多少种服务. 

```
小技巧: 如果etcd并不是装在本机,  可以用 --no-sync --endpoints 'serveraddr' 来强制指定远端地址. 
例如: etcdctl --no-sync --endpoints 'http://192.168.10.96:2379' ls /luban/nodes/trigger
```

或者使用我们用php+larvel编写的devops web操作工具包. <https://github.com/shopex/luban-devops>